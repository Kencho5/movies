<div class="min-h-screen bg-bg-dark text-white">
  <!-- Video Player -->
  <div class="relative">
    <div class="container mx-auto px-4 pt-4 md:px-6">
      @if (movieLoading()) {
        <div
          class="relative flex aspect-video items-center justify-center overflow-hidden rounded-md bg-bg-card lg:aspect-[21/9]"
        >
          <app-loading-dots></app-loading-dots>
        </div>
      } @else {
        @if (embedUrl()) {
          <div class="overflow-hidden rounded-md bg-bg-card">
            <iframe
              [src]="embedUrl()"
              class="aspect-video w-full bg-black lg:aspect-[21/9]"
              frameborder="0"
              allowfullscreen
            ></iframe>
          </div>
        } @else if (playerData().file) {
          <div class="relative overflow-hidden rounded-md bg-bg-card">
            <app-player
              [playerData]="playerData()"
              [playerClass]="'w-full aspect-video lg:aspect-[21/9] bg-black'"
            ></app-player>
          </div>
        } @else {
          <div
            class="relative aspect-video overflow-hidden rounded-md bg-bg-card lg:aspect-[21/9]"
          >
            <!-- Background Images -->
            @if (movie()) {
              <!-- Mobile: Use poster as backdrop -->
              <img
                [src]="movie()!.poster | imageSize: 'w780'"
                [alt]="movie()!.name"
                class="absolute inset-0 h-full w-full object-cover lg:hidden"
              />
              <!-- Desktop: Use backdrop if available, fallback to poster -->
              @if (movie()!.backdrop) {
                <img
                  [src]="movie()!.backdrop | imageSize: 'w1280'"
                  [alt]="movie()!.name"
                  class="absolute inset-0 hidden h-full w-full object-cover lg:block"
                />
              } @else {
                <img
                  [src]="movie()!.poster | imageSize: 'w780'"
                  [alt]="movie()!.name"
                  class="absolute inset-0 hidden h-full w-full object-cover lg:block"
                />
              }
            }

            <!-- Dark overlay for better contrast -->
            <div class="absolute inset-0 bg-black/70"></div>

            <!-- Content -->
            <div class="absolute inset-0 z-10 flex items-center justify-center">
              <div class="text-center max-w-sm mx-auto px-4">
                <div
                  class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-neutral-900/80 backdrop-blur-md border border-neutral-700"
                >
                  <svg
                    class="h-8 w-8 text-neutral-300"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15.75 5.25v13.5m-7.5-13.5v13.5"
                    />
                  </svg>
                </div>
                <div class="rounded-lg bg-neutral-900/90 backdrop-blur-md border border-neutral-700 px-4 py-3">
                  <p class="text-sm font-medium text-white">
                    {{ "WATCH.video_unavailable" | transloco }}
                  </p>
                  <p class="text-xs text-neutral-400 mt-1">
                    Content currently unavailable
                  </p>
                </div>
              </div>
            </div>
          </div>
        }
      }
    </div>
  </div>

  <div class="container mx-auto px-4 md:px-6">
    @if (movie()) {
      <!-- Main Content Grid -->
      <div class="py-6 lg:grid lg:grid-cols-[300px_1fr] lg:gap-8 lg:py-8">
        <!-- Left Column: Poster & Quick Info (Desktop Only) -->
        <div class="hidden lg:order-1 lg:block">
          <div class="lg:sticky lg:top-6">
            <!-- Poster -->
            <div
              class="mb-4 aspect-[2/3] w-full overflow-hidden rounded-md bg-bg-card lg:w-[300px]"
            >
              <img
                [src]="movie()!.poster | imageSize: 'w500'"
                [alt]="movie()!.name"
                class="h-full w-full object-cover"
              />
            </div>

            <!-- Rating & Links (Desktop) -->
            <div class="hidden space-y-3 lg:block">
              @if (movie()!.rating) {
                <div class="rounded-md bg-bg-card p-3">
                  <div class="flex items-center gap-2 text-sm">
                    <svg
                      class="h-4 w-4 text-yellow-500"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                      />
                    </svg>
                    <div>
                      <div class="font-semibold text-white">
                        {{ movie()!.rating }}
                      </div>
                      <div class="text-xs text-neutral-400">
                        {{ movie()!.vote_count | number }} votes
                      </div>
                    </div>
                  </div>
                </div>
              }

              <div class="space-y-2">
                @if (movie()!.imdb_id) {
                  <a
                    [href]="'https://www.imdb.com/title/' + movie()!.imdb_id"
                    target="_blank"
                    class="flex items-center gap-2 rounded-md bg-yellow-500/10 p-2 text-xs text-yellow-400 transition-colors hover:bg-yellow-500/20"
                  >
                    <svg
                      class="h-3 w-3"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                    >
                      <path
                        d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10zM8.5 16V8h1.5v8H8.5zm2.5 0V8h1.8l.8 3.5L14.4 8H16v8h-1.2v-5.8l-.8 3.8h-.8l-.8-3.8V16H10z"
                      />
                    </svg>
                    View on IMDb
                  </a>
                }
                @if (movie()!.tmdb_id) {
                  <a
                    [href]="
                      'https://www.themoviedb.org/movie/' + movie()!.tmdb_id
                    "
                    target="_blank"
                    class="flex items-center gap-2 rounded-md bg-primary-500/10 p-2 text-xs text-primary-400 transition-colors hover:bg-primary-500/20"
                  >
                    <svg
                      class="h-3 w-3"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                    >
                      <path
                        d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"
                      />
                    </svg>
                    View on TMDB
                  </a>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Main Content -->
        <div class="lg:order-2">
          <!-- Title & Meta -->
          <div class="mb-6">
            <h1
              class="mb-2 text-2xl font-bold leading-tight text-white lg:text-3xl"
            >
              {{ movie()!.name }}
            </h1>

            @if (movie()!.tagline) {
              <p class="mb-3 text-sm italic text-neutral-400 lg:text-base">
                "{{ movie()!.tagline }}"
              </p>
            }

            <!-- Meta Info -->
            <div
              class="mb-4 flex flex-wrap items-center gap-2 text-xs text-neutral-400 lg:gap-3 lg:text-sm"
            >
              <button 
                (click)="onYearClick(movie()!.year)"
                class="font-medium text-neutral-300 hover:text-primary-400 transition-colors cursor-pointer"
              >{{
                movie()!.year
              }}</button>
              @if (movie()!.runtime) {
                <span>{{ movie()!.runtime }}m</span>
              }
              @if (movie()!.certification) {
                <span
                  class="rounded border border-neutral-700 bg-neutral-800 px-1.5 py-0.5 text-xs font-medium text-neutral-300"
                >
                  {{ movie()!.certification | uppercase }}
                </span>
              }
              @if (movie()!.rating) {
                <div class="flex items-center gap-1 lg:hidden">
                  <svg
                    class="h-3 w-3 text-yellow-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                    />
                  </svg>
                  <span class="text-white">{{ movie()!.rating }}</span>
                </div>
              }
              @if (movie()!.status) {
                <span
                  class="inline-flex items-center rounded-full bg-green-500/20 px-2 py-0.5 text-xs font-medium text-green-400"
                >
                  <span class="mr-1 h-1 w-1 rounded-full bg-green-500"></span>
                  {{ movie()!.status | titlecase }}
                </span>
              }
            </div>

            <!-- Genres -->
            @if (movie()!.genres && movie()!.genres.length > 0) {
              <div class="mb-4 flex flex-wrap gap-1.5">
                @for (genre of movie()!.genres.slice(0, 5); track genre.id) {
                  <button
                    (click)="onGenreClick(genre)"
                    class="rounded-full bg-neutral-800 px-2 py-0.5 text-xs text-neutral-300 hover:bg-primary-600 hover:text-white transition-colors cursor-pointer"
                  >
                    {{ genre.display_name }}
                  </button>
                }
              </div>
            }

            <!-- Actions -->
            <div class="flex flex-wrap items-center gap-3">
              <button
                (click)="watchNow()"
                class="inline-flex items-center gap-2 rounded-md bg-primary-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-primary-700"
              >
                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                    clip-rule="evenodd"
                  />
                </svg>
                {{ "WATCH.watch_now" | transloco }}
              </button>

              <!-- Mobile Links -->
              <div class="flex gap-2 lg:hidden">
                @if (movie()!.imdb_id) {
                  <a
                    [href]="'https://www.imdb.com/title/' + movie()!.imdb_id"
                    target="_blank"
                    class="inline-flex items-center gap-1 text-xs text-neutral-400 transition-colors hover:text-yellow-400"
                  >
                    <svg
                      class="h-3 w-3"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                    >
                      <path
                        d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10zM8.5 16V8h1.5v8H8.5zm2.5 0V8h1.8l.8 3.5L14.4 8H16v8h-1.2v-5.8l-.8 3.8h-.8l-.8-3.8V16H10z"
                      />
                    </svg>
                    IMDb
                  </a>
                }
                @if (movie()!.tmdb_id) {
                  <a
                    [href]="
                      'https://www.themoviedb.org/movie/' + movie()!.tmdb_id
                    "
                    target="_blank"
                    class="inline-flex items-center gap-1 text-xs text-neutral-400 transition-colors hover:text-primary-400"
                  >
                    <svg
                      class="h-3 w-3"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                    >
                      <path
                        d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"
                      />
                    </svg>
                    TMDB
                  </a>
                }
              </div>
            </div>
          </div>

          <!-- Synopsis -->
          <div class="mb-6">
            <h2 class="mb-2 text-base font-semibold text-white">
              {{ "WATCH.synopsis" | transloco }}
            </h2>
            <p class="text-sm leading-relaxed text-neutral-300 lg:text-base">
              {{ movie()!.description }}
            </p>
          </div>

          <!-- Episodes (TV Shows) -->
          @if (movie()!.is_series) {
            <div class="mb-6">
              <div
                class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
              >
                <h2 class="text-base font-semibold text-white">
                  {{ "WATCH.seasons" | transloco }}
                </h2>
                <div class="flex gap-1">
                  @for (season of seasons(); track season.id) {
                    <button
                      (click)="onSeasonChange(season)"
                      [ngClass]="
                        selectedSeason()?.id === season.id
                          ? 'bg-primary-600 text-white'
                          : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700 hover:text-white'
                      "
                      class="rounded px-3 py-1 text-xs font-medium transition-colors"
                    >
                      S{{ season.number }}
                    </button>
                  }
                </div>
              </div>

              <div class="space-y-2">
                @if (episodesLoading()) {
                  @for (i of [].constructor(4); track $index) {
                    <div class="flex gap-3 rounded-md bg-bg-card p-3">
                      <div
                        class="h-12 w-20 animate-pulse rounded bg-neutral-700"
                      ></div>
                      <div class="flex-1 space-y-2">
                        <div
                          class="h-3 w-3/4 animate-pulse rounded bg-neutral-700"
                        ></div>
                        <div
                          class="h-2 w-full animate-pulse rounded bg-neutral-700"
                        ></div>
                      </div>
                    </div>
                  }
                } @else {
                  @for (episode of episodesForSeason(); track episode.id) {
                    <div
                      (click)="onEpisodeClick(episode)"
                      [ngClass]="
                        selectedEpisode()?.id === episode.id
                          ? 'border-primary-600 bg-primary-600/10'
                          : 'border-transparent bg-bg-card hover:bg-bg-highlight'
                      "
                      class="flex cursor-pointer gap-3 rounded-md border p-3 transition-colors"
                    >
                      <div
                        class="h-12 w-20 flex-shrink-0 overflow-hidden rounded bg-neutral-800"
                      >
                        @if (episode.poster) {
                          <app-image
                            [src]="episode.poster | imageSize: 'w185'"
                            [alt]="episode.name"
                            customClass="h-full w-full object-cover"
                          />
                        } @else {
                          <div
                            class="flex h-full w-full items-center justify-center"
                          >
                            <svg
                              class="h-3 w-3 text-neutral-600"
                              fill="currentColor"
                              viewBox="0 0 20 20"
                            >
                              <path
                                d="M10 3a1 1 0 011 1v5.586l2.293-2.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 9.586V4a1 1 0 011-1z"
                              />
                            </svg>
                          </div>
                        }
                      </div>
                      <div class="min-w-0 flex-1">
                        <h3 class="text-sm font-medium text-white">
                          {{ episode.episode_number }}. {{ episode.name }}
                        </h3>
                        <p class="mt-0.5 line-clamp-2 text-xs text-neutral-400">
                          {{
                            episode.description ||
                              ("WATCH.no_description" | transloco)
                          }}
                        </p>
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          }

          <!-- Cast -->
          @if (credits()?.actors && credits()!.actors.length > 0) {
            <div class="mb-6">
              <h2 class="mb-3 text-base font-semibold text-white">
                {{ "WATCH.cast" | transloco }}
              </h2>
              <div
                class="grid grid-cols-3 gap-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6"
              >
                @for (actor of credits()!.actors.slice(0, 12); track actor.id) {
                  <a [routerLink]="['/people', actor.id]" class="group">
                    <div
                      class="mb-2 aspect-[2/3] overflow-hidden rounded bg-neutral-800 transition-transform group-hover:scale-105"
                    >
                      @if (actor.poster) {
                        <app-image
                          [src]="actor.poster | imageSize: 'w185'"
                          [alt]="actor.name"
                          customClass="h-full w-full object-cover"
                        />
                      } @else {
                        <div class="flex h-full items-center justify-center">
                          <svg
                            class="h-5 w-5 text-neutral-600"
                            fill="currentColor"
                            viewBox="0 0 20 20"
                          >
                            <path
                              fill-rule="evenodd"
                              d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                              clip-rule="evenodd"
                            />
                          </svg>
                        </div>
                      }
                    </div>
                    <h3
                      class="text-xs font-medium text-white transition-colors group-hover:text-neutral-300"
                    >
                      {{ actor.name }}
                    </h3>
                    @if (actor.pivot?.character) {
                      <p class="text-xs text-neutral-500">
                        {{ actor.pivot?.character }}
                      </p>
                    }
                  </a>
                }
              </div>
            </div>
          }

          <!-- Details -->
          <div class="mb-6">
            <h2 class="mb-3 text-base font-semibold text-white">
              {{ "WATCH.details" | transloco }}
            </h2>
            <div class="grid gap-3 text-sm sm:grid-cols-2">
              @if (
                movie()!.credits?.directing &&
                movie()!.credits!.directing.length > 0
              ) {
                <div>
                  <dt class="text-xs font-medium text-neutral-400">
                    {{ "WATCH.director" | transloco }}
                  </dt>
                  <dd class="text-neutral-200">
                    @for (
                      director of movie()!.credits!.directing;
                      track director.id;
                      let isLast = $last
                    ) {
                      <span>{{ director.name }}</span>
                      @if (!isLast) {
                        <span>, </span>
                      }
                    }
                  </dd>
                </div>
              }
              @if (
                movie()!.credits?.writing &&
                movie()!.credits!.writing.length > 0
              ) {
                <div>
                  <dt class="text-xs font-medium text-neutral-400">
                    {{ "WATCH.writers" | transloco }}
                  </dt>
                  <dd class="text-neutral-200">
                    @for (
                      writer of movie()!.credits!.writing.slice(0, 2);
                      track writer.id;
                      let isLast = $last
                    ) {
                      <span>{{ writer.name }}</span>
                      @if (!isLast) {
                        <span>, </span>
                      }
                    }
                  </dd>
                </div>
              }
              <div>
                <dt class="text-xs font-medium text-neutral-400">
                  {{ "WATCH.release_date" | transloco }}
                </dt>
                <dd class="text-neutral-200">
                  {{ movie()!.release_date | date: "mediumDate" }}
                </dd>
              </div>
              @if (movie()!.runtime) {
                <div>
                  <dt class="text-xs font-medium text-neutral-400">
                    {{ "WATCH.runtime" | transloco }}
                  </dt>
                  <dd class="text-neutral-200">
                    {{ movie()!.runtime }} minutes
                  </dd>
                </div>
              }
              @if (movie()!.language) {
                <div>
                  <dt class="text-xs font-medium text-neutral-400">
                    {{ "WATCH.language" | transloco }}
                  </dt>
                  <dd class="text-neutral-200">{{ movie()!.language }}</dd>
                </div>
              }
              @if (
                movie()!.production_countries &&
                movie()!.production_countries.length > 0
              ) {
                <div>
                  <dt class="text-xs font-medium text-neutral-400">
                    {{ "WATCH.country" | transloco }}
                  </dt>
                  <dd class="text-neutral-200">
                    @for (
                      country of movie()!.production_countries;
                      track country.id;
                      let isLast = $last
                    ) {
                      <span>{{ country.display_name }}</span>
                      @if (!isLast) {
                        <span>, </span>
                      }
                    }
                  </dd>
                </div>
              }
              @if (movie()!.budget && movie()!.budget > 0) {
                <div>
                  <dt class="text-xs font-medium text-neutral-400">
                    {{ "WATCH.budget" | transloco }}
                  </dt>
                  <dd class="text-neutral-200">
                    ${{ movie()!.budget | number: "1.0-0" }}
                  </dd>
                </div>
              }
              @if (movie()!.revenue && movie()!.revenue > 0) {
                <div>
                  <dt class="text-xs font-medium text-neutral-400">
                    {{ "WATCH.box_office" | transloco }}
                  </dt>
                  <dd class="text-neutral-200">
                    ${{ movie()!.revenue | number: "1.0-0" }}
                  </dd>
                </div>
              }
              @if (movie()!.views) {
                <div>
                  <dt class="text-xs font-medium text-neutral-400">
                    {{ "WATCH.views" | transloco }}
                  </dt>
                  <dd class="text-neutral-200">
                    {{ movie()!.views | number }}
                  </dd>
                </div>
              }
            </div>
          </div>

          <!-- Keywords -->
          @if (movie()!.keywords && movie()!.keywords.length > 0) {
            <div>
              <h2 class="mb-2 text-base font-semibold text-white">
                {{ "WATCH.keywords" | transloco }}
              </h2>
              <div class="flex flex-wrap gap-1.5">
                @for (
                  keyword of movie()!.keywords.slice(0, 8);
                  track keyword.id
                ) {
                  <span
                    class="rounded-full bg-neutral-800 px-2 py-0.5 text-xs text-neutral-300"
                  >
                    {{ keyword.display_name }}
                  </span>
                }
              </div>
            </div>
          }
        </div>
      </div>
    } @else {
      <!-- Loading Skeleton -->
      <div class="py-6 lg:grid lg:grid-cols-[300px_1fr] lg:gap-8">
        <div
          class="hidden aspect-[2/3] w-full animate-pulse rounded-md bg-neutral-800 lg:block lg:w-[300px]"
        ></div>
        <div class="space-y-4">
          <div class="h-6 w-3/4 animate-pulse rounded bg-neutral-800"></div>
          <div class="h-3 w-1/2 animate-pulse rounded bg-neutral-800"></div>
          <div class="space-y-2">
            <div class="h-3 w-full animate-pulse rounded bg-neutral-800"></div>
            <div class="h-3 w-full animate-pulse rounded bg-neutral-800"></div>
            <div class="h-3 w-2/3 animate-pulse rounded bg-neutral-800"></div>
          </div>
        </div>
      </div>
    }
  </div>
</div>

